const express = require('express');
const { Octokit } = require('@octokit/rest');
const bodyParser = require('body-parser');
require('dotenv').config();

const app = express();
app.use(bodyParser.json());

const octokit = new Octokit({ auth: process.env.GITHUB_TOKEN });

app.post('/api/registrar-compra', async (req, res) => {
    const { nombre, telefono, numeros, total, fecha } = req.body;

    const content = `Nombre: ${nombre}\nTeléfono: ${telefono}\nNúmeros: ${numeros}\nTotal: $${total}\nFecha: ${fecha}\n\n`;

    try {
        // Obtener el contenido actual del archivo
        const { data: fileData } = await octokit.repos.getContent({
            owner: 'TuUsuarioDeGitHub',
            repo: 'TuRepositorio',
            path: 'registros.txt',
        });

        let newContent = Buffer.from(fileData.content, 'base64').toString() + content;

        // Actualizar el archivo en GitHub
        await octokit.repos.createOrUpdateFileContents({
            owner: 'TuUsuarioDeGitHub',
            repo: 'TuRepositorio',
            path: 'registros.txt',
            message: 'Nuevo registro de compra',
            content: Buffer.from(newContent).toString('base64'),
            sha: fileData.sha,
        });

        res.json({ success: true, message: 'Compra registrada con éxito' });
    } catch (error) {
        console.error('Error al registrar la compra:', error);
        res.status(500).json({ success: false, message: 'Error al registrar la compra' });
    }
});

const PORT = process.env.PORT || 3000;
app.listen(PORT, () => console.log(`Servidor corriendo en puerto ${PORT}`));
